<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½ç•ªèŒ„æ—¶é’Ÿå®Œæ•´ç‰ˆ | Comprehensive AI-Powered Pomodoro Timer</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .pulse-ring {
            animation: pulse-ring 1.5s ease-in-out infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .ai-thinking {
            animation: thinking 1.5s ease-in-out infinite;
        }
        @keyframes thinking {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .sortable-ghost {
            opacity: 0.4;
        }
        .task-card {
            transition: all 0.3s ease;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .ai-suggestion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
            to { box-shadow: 0 0 30px rgba(118, 75, 162, 0.4); }
        }
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }
        .category-work { background: linear-gradient(45deg, #fee2e2, #fef3c7); }
        .category-personal { background: linear-gradient(45deg, #dbeafe, #e0f2fe); }
        .category-learning { background: linear-gradient(45deg, #f3e8ff, #fdf4ff); }
        .category-health { background: linear-gradient(45deg, #dcfce7, #f0fdf4); }
        .time-block {
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 2px 0;
        }
        .time-block-work {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            color: white;
        }
        .time-block-break {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
        }
        .collaboration-indicator {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <!-- å¯¼å…¥AIæœåŠ¡å’Œæ•°æ®æŒä¹…åŒ–æ¨¡å— -->
    <script src="ai-task-service.js"></script>
    <script src="data-persistence.js"></script>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // è‡ªå®šä¹‰Inputç»„ä»¶è§£å†³ä¸­æ–‡è¾“å…¥é—®é¢˜
        const Input = (props) => {
          const inputRef = useRef(null);
          const { value, onChange, ...restProps } = props;
          
          // ç›´æ¥æ“ä½œDOMè®¾ç½®å€¼
          const forceSetValue = () => {
            if (inputRef.current) {
              inputRef.current.value = value;
              inputRef.current.setAttribute('value', value);
            }
          };
          
          return (
            <input
              {...restProps}
              defaultValue={value}
              ref={(el) => {
                if (el) {
                  inputRef.current = el;
                  forceSetValue();
                }
              }}
              onFocus={(e) => {
                setTimeout(forceSetValue, 10);
                props.onFocus && props.onFocus(e);
              }}
              onBlur={(e) => {
                setTimeout(forceSetValue, 150);
                props.onBlur && props.onBlur(e);
              }}
              onChange={(e) => {
                onChange && onChange(e.target.value);
              }}
            />
          );
        };

        // å®Œæ•´çš„AIç•ªèŒ„é’Ÿåº”ç”¨
        const ComprehensiveAIPomodoro = () => {
            // æ ¸å¿ƒè®¡æ—¶å™¨çŠ¶æ€
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [sessionType, setSessionType] = useState('work');
            const [sessionCount, setSessionCount] = useState(0);
            const [totalSessions, setTotalSessions] = useState(0);

            // ä»»åŠ¡ç®¡ç†çŠ¶æ€
            const [tasks, setTasks] = useState([]);
            const [currentTask, setCurrentTask] = useState(null);
            const [newTaskText, setNewTaskText] = useState('');
            const [priority, setPriority] = useState('medium');
            const [estimatedPomodoros, setEstimatedPomodoros] = useState(1);
            const [startTime, setStartTime] = useState('');
            const [endTime, setEndTime] = useState('');
            
            // è®¡ç®—é¢„è®¡ç»“æŸæ—¶é—´ï¼ˆä¿®æ­£æ—¶åŒºé—®é¢˜ï¼‰
            useEffect(() => {
              if (startTime && estimatedPomodoros > 0) {
                // è§£æè¾“å…¥æ—¶é—´ä¸ºæœ¬åœ°æ—¶é—´
                const start = new Date(startTime);
                
                // è®¡ç®—æ€»åˆ†é’Ÿæ•°ï¼ˆæ¯ä¸ªç•ªèŒ„é’Ÿ=25åˆ†é’Ÿå·¥ä½œ+5åˆ†é’Ÿä¼‘æ¯ï¼‰
                const totalMinutes = estimatedPomodoros * 30;
                
                // è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆæœ¬åœ°æ—¶é—´ï¼‰
                const endDate = new Date(start.getTime() + totalMinutes * 60000);
                
                // æ ¼å¼åŒ–ä¸ºæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸² (YYYY-MM-DDTHH:MM)
                const year = endDate.getFullYear();
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const day = String(endDate.getDate()).padStart(2, '0');
                const hours = String(endDate.getHours()).padStart(2, '0');
                const minutes = String(endDate.getMinutes()).padStart(2, '0');
                
                setEndTime(`${year}-${month}-${day}T${hours}:${minutes}`);
              } else {
                setEndTime('');
              }
            }, [startTime, estimatedPomodoros]);
            
            // UIçŠ¶æ€
            const [showTaskManager, setShowTaskManager] = useState(false);
            const [showAIChat, setShowAIChat] = useState(false);
            const [showAnalytics, setShowAnalytics] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showTimeBlocks, setShowTimeBlocks] = useState(false);
            const [showCollaboration, setShowCollaboration] = useState(false);
            
            // è¾“å…¥æ³•çŠ¶æ€
            const [isTaskComposing, setIsTaskComposing] = useState(false);
            const [isChatComposing, setIsChatComposing] = useState(false);

            // AIåŠŸèƒ½çŠ¶æ€
            const [aiService] = useState(() => new AITaskService());
            const [dataManager] = useState(() => new DataPersistenceManager({
                autoSaveInterval: 30000,
                maxBackups: 5,
                syncEnabled: true
            }));
            const [isAIProcessing, setIsAIProcessing] = useState(false);
            const [aiSuggestions, setAISuggestions] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [chatHistory, setChatHistory] = useState([]);
            
            // é«˜çº§åŠŸèƒ½çŠ¶æ€
            const [timeBlocks, setTimeBlocks] = useState([]);
            const [workloadAnalysis, setWorkloadAnalysis] = useState(null);
            const [riskAssessment, setRiskAssessment] = useState([]);
            const [learningInsights, setLearningInsights] = useState(null);
            const [userPreferences, setUserPreferences] = useState({
                energyLevel: 'medium',
                preferredWorkTime: 'morning',
                workStyle: 'focused',
                notifications: true,
                sounds: true,
                darkMode: false
            });

            // åä½œåŠŸèƒ½çŠ¶æ€
            const [collaborationEnabled, setCollaborationEnabled] = useState(false);
            const [activeUsers, setActiveUsers] = useState([]);
            const [sharedSessions, setSharedSessions] = useState([]);

            // åˆ†ææ•°æ®çŠ¶æ€
            const [completionHistory, setCompletionHistory] = useState([]);
            const [productivityMetrics, setProductivityMetrics] = useState({});
            const [notifications, setNotifications] = useState([]);

            const intervalRef = useRef(null);
            const chartRef = useRef(null);
            const dragContainerRef = useRef(null);

            // ä¼šè¯é…ç½®
            const sessionTimes = {
                work: 25 * 60,
                shortBreak: 5 * 60,
                longBreak: 15 * 60
            };

            const sessionNames = {
                work: 'ä¸“æ³¨å·¥ä½œ',
                shortBreak: 'çŸ­ä¼‘æ¯',
                longBreak: 'é•¿ä¼‘æ¯'
            };

            const sessionColors = {
                work: 'from-indigo-500 to-purple-600',
                shortBreak: 'from-green-500 to-emerald-500',
                longBreak: 'from-blue-500 to-cyan-500'
            };

            // å·¥å…·å‡½æ•°
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const getProgress = () => {
                const total = sessionTimes[sessionType];
                return ((total - timeLeft) / total) * 100;
            };

            const generateTaskId = () => `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            const addNotification = (message, type = 'info') => {
                const notification = {
                    id: Date.now(),
                    message,
                    type,
                    timestamp: new Date(),
                    read: false
                };
                
                setNotifications(prev => [notification, ...prev.slice(0, 9)]); // ä¿ç•™æœ€æ–°10æ¡
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== notification.id));
                }, 3000);
            };

            // AIåˆ†æåŠŸèƒ½
            const analyzeTasksWithAI = useCallback(async () => {
                if (tasks.length === 0) return;

                setIsAIProcessing(true);
                addNotification('ğŸ¤– AIæ­£åœ¨åˆ†ææ‚¨çš„ä»»åŠ¡å®‰æ’...', 'info');
                
                try {
                    const userContext = {
                        ...userPreferences,
                        currentTime: new Date().toISOString(),
                        completionHistory,
                        productivityMetrics
                    };

                    const result = await aiService.analyzeTasksWithAI(tasks, userContext);
                    
                    if (result.success) {
                        const data = result.data;
                        
                        setAISuggestions(data.suggestions || []);
                        setTimeBlocks(data.timeBlocks || []);
                        setWorkloadAnalysis(data.workloadAnalysis);
                        setRiskAssessment(data.riskAssessment || []);
                        setLearningInsights(data.learningInsights);

                        // å¦‚æœæœ‰ä¼˜åŒ–çš„ä»»åŠ¡é¡ºåºï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦åº”ç”¨
                        if (data.optimizedOrder && data.optimizedOrder.length > 0) {
                            setChatHistory(prev => [...prev, {
                                type: 'assistant',
                                message: `âœ¨ AIåˆ†æå®Œæˆï¼å‘ç°${data.suggestions?.length || 0}ä¸ªä¼˜åŒ–å»ºè®®ã€‚æ˜¯å¦åº”ç”¨AIæ¨èçš„ä»»åŠ¡é¡ºåºï¼Ÿ`,
                                timestamp: new Date(),
                                actionData: { optimizedOrder: data.optimizedOrder }
                            }]);
                        }

                        addNotification('âœ… AIåˆ†æå®Œæˆï¼Œå‘ç°äº†ä¼˜åŒ–å»ºè®®', 'success');
                    } else {
                        addNotification('âš ï¸ AIåˆ†æå¤±è´¥ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼', 'warning');
                    }

                } catch (error) {
                    console.error('AIåˆ†æå¤±è´¥:', error);
                    addNotification('âŒ AIåˆ†æé‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•', 'error');
                } finally {
                    setIsAIProcessing(false);
                }
            }, [tasks, userPreferences, completionHistory, productivityMetrics, aiService]);

            // è‡ªç„¶è¯­è¨€å¤„ç†
            const handleNaturalLanguageInput = async (input) => {
                if (!input.trim()) return;

                setIsAIProcessing(true);
                setChatHistory(prev => [...prev, {
                    type: 'user',
                    message: input,
                    timestamp: new Date()
                }]);

                try {
                    const result = await aiService.processNaturalLanguage(input, tasks);
                    
                    if (result.success && result.action) {
                        await executeAIAction(result.action);
                    }

                    setChatHistory(prev => [...prev, {
                        type: 'assistant',
                        message: result.response || 'å·²å¤„ç†æ‚¨çš„è¯·æ±‚',
                        timestamp: new Date(),
                        suggestions: result.suggestions
                    }]);

                } catch (error) {
                    console.error('è‡ªç„¶è¯­è¨€å¤„ç†å¤±è´¥:', error);
                    setChatHistory(prev => [...prev, {
                        type: 'error',
                        message: 'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„æ„æ€ï¼Œè¯·é‡æ–°è¡¨è¾¾',
                        timestamp: new Date()
                    }]);
                } finally {
                    setIsAIProcessing(false);
                    setChatInput('');
                }
            };

            const executeAIAction = async (action) => {
                switch (action.type) {
                    case 'add_task':
                        if (action.parameters?.taskText) {
                            await addTaskWithAI(action.parameters);
                        }
                        break;
                    case 'reorder_tasks':
                        if (action.parameters?.optimizedOrder) {
                            reorderTasks(action.parameters.optimizedOrder);
                            addNotification('ğŸ“‹ ä»»åŠ¡é¡ºåºå·²ä¼˜åŒ–', 'success');
                        }
                        break;
                    case 'set_priority':
                        if (action.parameters?.taskId && action.parameters?.priority) {
                            updateTaskPriority(action.parameters.taskId, action.parameters.priority);
                            addNotification('ğŸ¯ ä»»åŠ¡ä¼˜å…ˆçº§å·²æ›´æ–°', 'success');
                        }
                        break;
                    case 'get_analysis':
                        await analyzeTasksWithAI();
                        break;
                }
            };

            // ä»»åŠ¡ç®¡ç†åŠŸèƒ½
            const addTaskWithAI = async (taskData) => {
                try {
                    const categoryResult = await aiService.categorizeTask(taskData.taskText || taskData);
                    
                    let category = {};
                    if (categoryResult.success) {
                        category = categoryResult.data;
                    }

                    const newTask = {
                        id: generateTaskId(),
                        text: taskData.taskText || taskData,
                        completed: false,
                        estimatedPomodoros: category.estimatedPomodoros || taskData.estimatedPomodoros || 1,
                        completedPomodoros: 0,
                        priority: category.priority || taskData.priority || 'medium',
                        category: category.category || taskData.category || 'work',
                        complexity: category.complexity || 'medium',
                        timeOfDay: category.timeOfDay || 'anytime',
                        tags: category.tags || [],
                        deadline: taskData.deadline || null,
                        createdAt: new Date().toISOString(),
                        aiGenerated: true,
                        energyRequired: category.energyRequired || 'medium',
                        focusLevel: category.focusLevel || 'medium'
                    };

                    const updatedTasks = [...tasks, newTask];
                    setTasks(updatedTasks);
                    dataManager.save('tasks', updatedTasks);
                    
                    addNotification(`âœ… æ™ºèƒ½æ·»åŠ ä»»åŠ¡: ${newTask.text}`, 'success');

                } catch (error) {
                    console.error('AIä»»åŠ¡æ·»åŠ å¤±è´¥:', error);
                    addBasicTask(taskData.taskText || taskData);
                }
            };

            const addBasicTask = () => {
                if (newTaskText.trim() === '') {
                    addNotification('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹', 'warning');
                    return;
                }

                const newTask = {
                    id: generateTaskId(),
                    text: newTaskText.trim(),
                    completed: false,
                    estimatedPomodoros: estimatedPomodoros,
                    completedPomodoros: 0,
                    priority: priority,
                    category: 'work',
                    createdAt: new Date().toISOString(),
                    aiGenerated: false,
                    startTime: startTime,
                    endTime: endTime
                };
                
                const updatedTasks = [...tasks, newTask];
                setTasks(updatedTasks);
                dataManager.save('tasks', updatedTasks);
                setNewTaskText('');
                setPriority('medium');
                setEstimatedPomodoros(1);
                setStartTime('');
                setEndTime('');
                
                addNotification('ğŸ“ ä»»åŠ¡å·²æ·»åŠ ', 'success');
            };

            const deleteTask = (taskId) => {
                const updatedTasks = tasks.filter(task => task.id !== taskId);
                setTasks(updatedTasks);
                dataManager.save('tasks', updatedTasks);
                
                if (currentTask && currentTask.id === taskId) {
                    setCurrentTask(null);
                }
                
                addNotification('ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤', 'info');
            };

            const toggleTaskComplete = (taskId) => {
                const updatedTasks = tasks.map(task => {
                    if (task.id === taskId) {
                        const completed = !task.completed;
                        if (completed) {
                            recordTaskCompletion(task);
                        }
                        return { ...task, completed };
                    }
                    return task;
                });
                setTasks(updatedTasks);
                dataManager.save('tasks', updatedTasks);
            };

            const updateTaskEstimate = (taskId, estimate) => {
                const updatedTasks = tasks.map(task =>
                    task.id === taskId ? { ...task, estimatedPomodoros: Math.max(1, estimate) } : task
                );
                setTasks(updatedTasks);
                dataManager.save('tasks', updatedTasks);
            };

            const updateTaskPriority = (taskId, priority) => {
                const updatedTasks = tasks.map(task =>
                    task.id === taskId ? { ...task, priority } : task
                );
                setTasks(updatedTasks);
                dataManager.save('tasks', updatedTasks);
            };

            const reorderTasks = (newOrder) => {
                const reorderedTasks = newOrder.map(id => tasks.find(task => task.id === id)).filter(Boolean);
                setTasks(reorderedTasks);
                dataManager.save('tasks', reorderedTasks);
            };

            const selectCurrentTask = (task) => {
                setCurrentTask(task);
                dataManager.save('currentTask', task);
                setShowTaskManager(false);
                addNotification(`ğŸ¯ é€‰æ‹©ä»»åŠ¡: ${task.text}`, 'info');
            };

            // æ•°æ®è®°å½•å’Œå­¦ä¹ 
            const recordTaskCompletion = (task) => {
                const completion = {
                    taskId: task.id,
                    taskText: task.text,
                    category: task.category,
                    priority: task.priority,
                    estimatedPomodoros: task.estimatedPomodoros,
                    actualPomodoros: task.completedPomodoros,
                    completedAt: new Date().toISOString(),
                    sessionType: sessionType
                };

                setCompletionHistory(prev => {
                    const updated = [completion, ...prev.slice(0, 99)]; // ä¿ç•™æœ€è¿‘100ä¸ªè®°å½•
                    dataManager.save('completionHistory', updated);
                    return updated;
                });

                updateProductivityMetrics(completion);
                addNotification(`ğŸ‰ å®Œæˆä»»åŠ¡: ${task.text}`, 'success');
            };

            const updateProductivityMetrics = (completion) => {
                setProductivityMetrics(prev => {
                    const hour = new Date().getHours();
                    const dayOfWeek = new Date().getDay();
                    
                    const updated = {
                        ...prev,
                        totalCompletedTasks: (prev.totalCompletedTasks || 0) + 1,
                        totalPomodoros: (prev.totalPomodoros || 0) + completion.actualPomodoros,
                        averageAccuracy: calculateAccuracy(completion),
                        productiveHours: updateProductiveHours(prev.productiveHours || {}, hour),
                        productiveDays: updateProductiveDays(prev.productiveDays || {}, dayOfWeek),
                        categoryStats: updateCategoryStats(prev.categoryStats || {}, completion.category)
                    };
                    
                    dataManager.save('productivityMetrics', updated);
                    return updated;
                });
            };

            const calculateAccuracy = (completion) => {
                return completion.estimatedPomodoros > 0 ? 
                    Math.min(100, (completion.actualPomodoros / completion.estimatedPomodoros) * 100) : 0;
            };

            const updateProductiveHours = (hours, hour) => {
                return { ...hours, [hour]: (hours[hour] || 0) + 1 };
            };

            const updateProductiveDays = (days, day) => {
                return { ...days, [day]: (days[day] || 0) + 1 };
            };

            const updateCategoryStats = (stats, category) => {
                return { ...stats, [category]: (stats[category] || 0) + 1 };
            };

            // è®¡æ—¶å™¨åŠŸèƒ½
            const playNotificationSound = () => {
                if (!userPreferences.sounds) return;
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            };

            const sendNotification = (message) => {
                if (!userPreferences.notifications) return;
                
                if (Notification.permission === 'granted') {
                    new Notification('AIç•ªèŒ„æ—¶é’Ÿ', {
                        body: message,
                        icon: '/favicon.ico'
                    });
                }
                
                addNotification(message, 'info');
            };

            const switchSession = () => {
                if (sessionType === 'work') {
                    const newCount = sessionCount + 1;
                    setSessionCount(newCount);
                    setTotalSessions(totalSessions + 1);
                    
                    if (currentTask) {
                        const updatedTasks = tasks.map(task =>
                            task.id === currentTask.id
                                ? { ...task, completedPomodoros: task.completedPomodoros + 1 }
                                : task
                        );
                        setTasks(updatedTasks);
                        dataManager.save('tasks', updatedTasks);
                    }

                    dataManager.save('sessionStats', { sessionCount: newCount, totalSessions: totalSessions + 1 });
                    
                    if (newCount % 4 === 0) {
                        setSessionType('longBreak');
                        setTimeLeft(sessionTimes.longBreak);
                        sendNotification('ğŸ‰ æ­å–œå®Œæˆ4ä¸ªç•ªèŒ„ï¼å¼€å§‹é•¿ä¼‘æ¯å§ï¼');
                    } else {
                        setSessionType('shortBreak');
                        setTimeLeft(sessionTimes.shortBreak);
                        sendNotification('âœ… ç•ªèŒ„æ—¶é—´ç»“æŸï¼å¼€å§‹çŸ­ä¼‘æ¯å§ï¼');
                    }
                } else {
                    setSessionType('work');
                    setTimeLeft(sessionTimes.work);
                    sendNotification('ğŸš€ ä¼‘æ¯ç»“æŸï¼å¼€å§‹æ–°çš„ç•ªèŒ„æ—¶é—´ï¼');
                }
                setIsActive(false);
            };

            // åˆå§‹åŒ–
            useEffect(() => {
                const loadData = async () => {
                    const savedTasks = dataManager.load('tasks', []);
                    const savedCurrentTask = dataManager.load('currentTask', null);
                    const savedSessionStats = dataManager.load('sessionStats', { sessionCount: 0, totalSessions: 0 });
                    const savedPreferences = dataManager.load('userPreferences', userPreferences);
                    const savedCompletionHistory = dataManager.load('completionHistory', []);
                    const savedProductivityMetrics = dataManager.load('productivityMetrics', {});

                    setTasks(savedTasks);
                    setCurrentTask(savedCurrentTask);
                    setSessionCount(savedSessionStats.sessionCount);
                    setTotalSessions(savedSessionStats.totalSessions);
                    setUserPreferences(savedPreferences);
                    setCompletionHistory(savedCompletionHistory);
                    setProductivityMetrics(savedProductivityMetrics);

                    // è¯·æ±‚é€šçŸ¥æƒé™
                    if (Notification.permission === 'default') {
                        Notification.requestPermission();
                    }

                    // åˆå§‹AIåˆ†æ
                    if (savedTasks.length > 0) {
                        setTimeout(() => {
                            analyzeTasksWithAI();
                        }, 2000);
                    }
                };

                loadData();

                // è®¾ç½®æ•°æ®åŒæ­¥ç›‘å¬
                const handleDataSync = (event) => {
                    const { key, data } = event.detail;
                    if (key === 'tasks') {
                        setTasks(data || []);
                    }
                };

                window.addEventListener('dataSync', handleDataSync);
                
                return () => {
                    window.removeEventListener('dataSync', handleDataSync);
                };
            }, []);

            // è®¡æ—¶å™¨æ•ˆæœ
            useEffect(() => {
                if (isActive && timeLeft > 0) {
                    intervalRef.current = setInterval(() => {
                        setTimeLeft(timeLeft => timeLeft - 1);
                    }, 1000);
                } else if (timeLeft === 0) {
                    playNotificationSound();
                    switchSession();
                }

                return () => clearInterval(intervalRef.current);
            }, [isActive, timeLeft]);

            // è‡ªåŠ¨ä¿å­˜åå¥½è®¾ç½®
            useEffect(() => {
                dataManager.save('userPreferences', userPreferences);
            }, [userPreferences]);

            const toggleTimer = () => {
                setIsActive(!isActive);
            };

            const resetTimer = () => {
                setIsActive(false);
                setTimeLeft(sessionTimes[sessionType]);
            };

            const changeSessionType = (type) => {
                setSessionType(type);
                setTimeLeft(sessionTimes[type]);
                setIsActive(false);
            };

            // åä½œåŠŸèƒ½
            const enableCollaboration = () => {
                setCollaborationEnabled(true);
                dataManager.enableCollaboration({
                    roomId: `room_${Date.now()}`,
                    userId: dataManager.getUserId()
                });
                addNotification('ğŸ¤ åä½œæ¨¡å¼å·²å¼€å¯', 'success');
            };

            const shareSession = async () => {
                try {
                    const shareData = {
                        tasks,
                        currentTask,
                        userPreferences,
                        sessionStats: { sessionCount, totalSessions }
                    };
                    
                    const shareInfo = dataManager.shareData('session', ['read', 'write']);
                    
                    // å¤åˆ¶åˆ†äº«é“¾æ¥åˆ°å‰ªè´´æ¿
                    await navigator.clipboard.writeText(shareInfo.shareUrl);
                    addNotification('ğŸ”— åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    
                } catch (error) {
                    console.error('åˆ†äº«å¤±è´¥:', error);
                    addNotification('âŒ åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            };

            // æ•°æ®å¯¼å‡ºå¯¼å…¥
            const exportData = () => {
                const exportData = dataManager.exportData();
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `ai-pomodoro-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                addNotification('ğŸ“ æ•°æ®å·²å¯¼å‡º', 'success');
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importData = JSON.parse(e.target.result);
                        const results = dataManager.importData(importData, { merge: true });
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        const newTasks = dataManager.load('tasks', []);
                        setTasks(newTasks);
                        
                        addNotification('ğŸ“¥ æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                        
                    } catch (error) {
                        console.error('å¯¼å…¥å¤±è´¥:', error);
                        addNotification('âŒ æ•°æ®å¯¼å…¥å¤±è´¥', 'error');
                    }
                };
                reader.readAsText(file);
            };

            // ç»„ä»¶å®šä¹‰
            const NotificationPanel = () => (
                <div className="fixed top-4 right-4 z-50 space-y-2">
                    {notifications.map(notification => (
                        <div
                            key={notification.id}
                            className={`notification px-4 py-2 rounded-lg shadow-lg text-white text-sm max-w-sm ${
                                notification.type === 'success' ? 'bg-green-500' :
                                notification.type === 'error' ? 'bg-red-500' :
                                notification.type === 'warning' ? 'bg-yellow-500' :
                                'bg-blue-500'
                            }`}
                        >
                            {notification.message}
                        </div>
                    ))}
                </div>
            );

            const AIChat = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-2xl w-full max-h-[80vh] flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹</h2>
                            <button
                                onClick={() => setShowAIChat(false)}
                                className="text-gray-500 hover:text-gray-700 text-2xl"
                            >
                                Ã—
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto mb-4 space-y-3 min-h-[300px]">
                            {chatHistory.length === 0 ? (
                                <div className="text-center text-gray-500 py-8">
                                    <div className="text-4xl mb-4">ğŸ¯</div>
                                    <p>æˆ‘æ˜¯æ‚¨çš„AIç•ªèŒ„æ—¶é’ŸåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨ï¼š</p>
                                    <ul className="text-sm mt-2 space-y-1">
                                        <li>â€¢ æ™ºèƒ½æ·»åŠ å’Œåˆ†ç±»ä»»åŠ¡</li>
                                        <li>â€¢ ä¼˜åŒ–ä»»åŠ¡æ‰§è¡Œé¡ºåº</li>
                                        <li>â€¢ åˆ†æå·¥ä½œæ¨¡å¼å’Œæ•ˆç‡</li>
                                        <li>â€¢ æä¾›ä¸ªæ€§åŒ–å»ºè®®</li>
                                        <li>â€¢ é¢„æµ‹ä»»åŠ¡æ—¶é—´å’Œå¤æ‚åº¦</li>
                                    </ul>
                                </div>
                            ) : (
                                chatHistory.map((msg, index) => (
                                    <div key={index} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] p-3 rounded-lg ${
                                            msg.type === 'user' 
                                                ? 'bg-indigo-500 text-white' 
                                                : msg.type === 'error'
                                                ? 'bg-red-100 text-red-800'
                                                : 'bg-gray-100 text-gray-800'
                                        }`}>
                                            <p>{msg.message}</p>
                                            
                                            {msg.actionData && (
                                                <div className="mt-2">
                                                    <button
                                                        onClick={() => executeAIAction({ 
                                                            type: 'reorder_tasks', 
                                                            parameters: { optimizedOrder: msg.actionData.optimizedOrder }
                                                        })}
                                                        className="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
                                                    >
                                                        åº”ç”¨ä¼˜åŒ–é¡ºåº
                                                    </button>
                                                </div>
                                            )}
                                            
                                            {msg.suggestions && (
                                                <div className="mt-2 space-y-1">
                                                    {msg.suggestions.map((suggestion, i) => (
                                                        <div key={i} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded">
                                                            {suggestion}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            <div className="text-xs opacity-70 mt-1">
                                                {msg.timestamp.toLocaleTimeString('zh-CN')}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                            {isAIProcessing && (
                                <div className="flex justify-start">
                                    <div className="bg-gray-100 text-gray-800 p-3 rounded-lg">
                                        <div className="ai-thinking">ğŸ¤” æ€è€ƒä¸­...</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex space-x-2">
                            <Input
                              key="chat-input"
                              type="text"
                              value={chatInput}
                              onChange={(value) => {
                                if (!isChatComposing) {
                                  setChatInput(value);
                                }
                              }}
                              onCompositionStart={() => setIsChatComposing(true)}
                              onCompositionEnd={(e) => {
                                setIsChatComposing(false);
                                setChatInput(e.target.value);
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter' && !isChatComposing && !isAIProcessing && chatInput.trim()) {
                                  e.preventDefault();
                                  handleNaturalLanguageInput(chatInput);
                                }
                              }}
                              placeholder="å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©..."
                              className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                              autoComplete="off"
                              spellCheck={false}
                              autoCorrect="off"
                              autoCapitalize="off"
                              autoFocus
                            />
                            <button
                                onClick={() => handleNaturalLanguageInput(chatInput)}
                                disabled={isAIProcessing || !chatInput.trim()}
                                className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors disabled:opacity-50"
                            >
                                å‘é€
                            </button>
                        </div>

                        <div className="flex flex-wrap gap-2 mt-4">
                            <button
                                onClick={() => setChatInput('å¸®æˆ‘ä¼˜åŒ–ä»Šå¤©çš„ä»»åŠ¡å®‰æ’')}
                                className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm hover:bg-purple-200"
                            >
                                ä¼˜åŒ–ä»»åŠ¡
                            </button>
                            <button
                                onClick={() => setChatInput('åˆ†ææˆ‘çš„å·¥ä½œæ•ˆç‡æ¨¡å¼')}
                                className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200"
                            >
                                æ•ˆç‡åˆ†æ
                            </button>
                            <button
                                onClick={() => setChatInput('æ¨èåˆé€‚çš„ä¼‘æ¯å®‰æ’')}
                                className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200"
                            >
                                ä¼‘æ¯å»ºè®®
                            </button>
                            <button
                                onClick={() => setChatInput('é¢„æµ‹ä»Šå¤©çš„å·¥ä½œè´Ÿè·')}
                                className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm hover:bg-orange-200"
                            >
                                è´Ÿè·é¢„æµ‹
                            </button>
                        </div>
                    </div>
                </div>
            );

            // æ—¶é—´å—è§†å›¾ç»„ä»¶
            const TimeBlocksView = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">â° æ™ºèƒ½æ—¶é—´è§„åˆ’</h2>
                            <button
                                onClick={() => setShowTimeBlocks(false)}
                                className="text-gray-500 hover:text-gray-700 text-2xl"
                            >
                                Ã—
                            </button>
                        </div>

                        {timeBlocks.length === 0 ? (
                            <div className="text-center text-gray-500 py-8">
                                <div className="text-4xl mb-4">ğŸ“…</div>
                                <p>AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆæ—¶é—´è§„åˆ’...</p>
                                <button
                                    onClick={analyzeTasksWithAI}
                                    className="mt-4 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                                >
                                    ç”Ÿæˆæ—¶é—´è§„åˆ’
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                <div className="grid grid-cols-12 gap-2 text-sm font-medium text-gray-600 mb-4">
                                    <div className="col-span-3">æ—¶é—´</div>
                                    <div className="col-span-6">ä»»åŠ¡</div>
                                    <div className="col-span-3">ç±»å‹</div>
                                </div>
                                
                                {timeBlocks.map((block, index) => (
                                    <div
                                        key={index}
                                        className={`time-block p-3 grid grid-cols-12 gap-2 items-center ${
                                            block.type === 'work' ? 'time-block-work' : 'time-block-break'
                                        }`}
                                    >
                                        <div className="col-span-3 font-medium">
                                            {block.startTime} - {block.endTime}
                                        </div>
                                        <div className="col-span-6">
                                            {block.type === 'work' ? (
                                                <div>
                                                    <div className="font-medium">
                                                        {tasks.find(t => t.id === block.taskId)?.text || 'æœªçŸ¥ä»»åŠ¡'}
                                                    </div>
                                                    <div className="text-xs opacity-80 mt-1">
                                                        {block.reason}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="italic">{block.reason}</div>
                                            )}
                                        </div>
                                        <div className="col-span-3">
                                            {block.type === 'work' ? 'ğŸ… å·¥ä½œ' : 'â˜• ä¼‘æ¯'}
                                        </div>
                                    </div>
                                ))}
                                
                                <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                                    <h3 className="font-semibold text-blue-800 mb-2">ğŸ“Š æ—¶é—´è§„åˆ’æ€»è§ˆ</h3>
                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <div className="font-medium text-blue-700">æ€»å·¥ä½œæ—¶é—´</div>
                                            <div className="text-blue-600">
                                                {timeBlocks.filter(b => b.type === 'work').length * 25} åˆ†é’Ÿ
                                            </div>
                                        </div>
                                        <div>
                                            <div className="font-medium text-blue-700">ä¼‘æ¯æ—¶é—´</div>
                                            <div className="text-blue-600">
                                                {timeBlocks.filter(b => b.type === 'break').length * 5} åˆ†é’Ÿ
                                            </div>
                                        </div>
                                        <div>
                                            <div className="font-medium text-blue-700">é¢„è®¡å®Œæˆæ—¶é—´</div>
                                            <div className="text-blue-600">
                                                {timeBlocks.length > 0 ? timeBlocks[timeBlocks.length - 1].endTime : '--:--'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // ä»»åŠ¡ç®¡ç†å™¨ç»„ä»¶
            const TaskManager = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">ğŸ“‹ æ™ºèƒ½ä»»åŠ¡ç®¡ç†</h2>
                            <div className="flex space-x-2">
                                <button
                                    onClick={analyzeTasksWithAI}
                                    disabled={isAIProcessing}
                                    className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors disabled:opacity-50"
                                >
                                    {isAIProcessing ? 'åˆ†æä¸­...' : 'ğŸ”„ AIåˆ†æ'}
                                </button>
                                <button
                                    onClick={() => setShowTaskManager(false)}
                                    className="text-gray-500 hover:text-gray-700 text-2xl"
                                >
                                    Ã—
                                </button>
                            </div>
                        </div>

                        {/* æ·»åŠ æ–°ä»»åŠ¡ */}
                        <div className="mb-6">
                          <div className="grid grid-cols-1 gap-4">
                            <div className="flex space-x-2">
                                <Input
                                  key="task-input"
                                  type="text"
                                  value={newTaskText}
                                  onChange={(value) => {
                                    if (!isTaskComposing) {
                                      setNewTaskText(value);
                                    }
                                  }}
                                  onCompositionStart={() => setIsTaskComposing(true)}
                                  onCompositionEnd={(e) => {
                                    setIsTaskComposing(false);
                                    setNewTaskText(e.target.value);
                                  }}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter' && !isTaskComposing) {
                                      e.preventDefault();
                                      addBasicTask();
                                    }
                                  }}
                                  placeholder="è¾“å…¥æ–°ä»»åŠ¡..."
                                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                  autoComplete="off"
                                  spellCheck={false}
                                  autoFocus
                                />
                                <button
                                    onClick={addBasicTask}
                                    className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors"
                                    id="add-task-button"
                                >
                                    æ·»åŠ 
                                </button>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">ä¼˜å…ˆçº§</label>
                                <select
                                  value={priority}
                                  onChange={(e) => setPriority(e.target.value)}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                  <option value="high">é«˜</option>
                                  <option value="medium">ä¸­</option>
                                  <option value="low">ä½</option>
                                </select>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">ç•ªèŒ„é’Ÿæ•°</label>
                                <input
                                  type="number"
                                  min="1"
                                  value={estimatedPomodoros}
                                  onChange={(e) => setEstimatedPomodoros(parseInt(e.target.value) || 1)}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                              </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å¼€å§‹æ—¶é—´</label>
                                <input
                                  type="datetime-local"
                                  value={startTime}
                                  onChange={(e) => setStartTime(e.target.value)}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">é¢„è®¡ç»“æŸ</label>
                                <input
                                  type="datetime-local"
                                  value={endTime}
                                  readOnly
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                />
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* ä»»åŠ¡åˆ—è¡¨ */}
                        <div className="space-y-3">
                            {tasks.length === 0 ? (
                                <div className="text-center text-gray-500 py-8">
                                    <div className="text-4xl mb-4">ğŸ“</div>
                                    <p>è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªå¼€å§‹å§ï¼</p>
                                </div>
                            ) : (
                                tasks.map(task => (
                                    <div
                                        key={task.id}
                                        className={`p-4 border rounded-xl ${task.completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-300'} ${
                                            task.priority === 'high' ? 'border-l-4 border-l-red-500' :
                                            task.priority === 'medium' ? 'border-l-4 border-l-yellow-500' :
                                            'border-l-4 border-l-green-500'
                                        }`}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center space-x-3 flex-1">
                                                <input
                                                    type="checkbox"
                                                    checked={task.completed}
                                                    onChange={() => toggleTaskComplete(task.id)}
                                                    className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
                                                />
                                                <div className="flex-1">
                                                    <div className={`font-medium ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                                                        {task.text}
                                                    </div>
                                                    <div className="flex items-center space-x-2 mt-1">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${
                                                            task.priority === 'high' ? 'bg-red-100 text-red-700' :
                                                            task.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                                            'bg-green-100 text-green-700'
                                                        }`}>
                                                            {task.priority === 'high' ? 'ğŸ”´ é«˜ä¼˜å…ˆçº§' : task.priority === 'medium' ? 'ğŸŸ¡ ä¸­ä¼˜å…ˆçº§' : 'ğŸŸ¢ ä½ä¼˜å…ˆçº§'}
                                                        </span>
                                                        {task.aiGenerated && (
                                                            <span className="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded-full">
                                                                ğŸ¤– AIç”Ÿæˆ
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    onClick={() => selectCurrentTask(task)}
                                                    className="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
                                                >
                                                    é€‰æ‹©
                                                </button>
                                                <button
                                                    onClick={() => deleteTask(task.id)}
                                                    className="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors"
                                                >
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div className="mt-3 flex items-center justify-between text-sm text-gray-600">
                                            <div className="flex items-center space-x-2">
                                                <span>é¢„è®¡:</span>
                                                <input
                                                    type="number"
                                                    value={task.estimatedPomodoros}
                                                    onChange={(e) => updateTaskEstimate(task.id, parseInt(e.target.value) || 1)}
                                                    min="1"
                                                    className="w-16 px-2 py-1 border border-gray-300 rounded text-center"
                                                />
                                                <span>ğŸ…</span>
                                            </div>
                                            <div>
                                                å·²å®Œæˆ: {task.completedPomodoros} / {task.estimatedPomodoros} ğŸ…
                                            </div>
                                        </div>
                                        
                                        {/* è¿›åº¦æ¡ */}
                                        <div className="mt-2 w-full bg-gray-200 rounded-full h-2">
                                            <div
                                                className={`h-2 rounded-full transition-all ${
                                                    task.priority === 'high' ? 'bg-red-500' :
                                                    task.priority === 'medium' ? 'bg-yellow-500' :
                                                    'bg-green-500'
                                                }`}
                                                style={{ width: `${Math.min(100, (task.completedPomodoros / task.estimatedPomodoros) * 100)}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );

            // æ•°æ®åˆ†æç»„ä»¶
            const Analytics = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">ğŸ“Š æ•ˆç‡åˆ†æ</h2>
                            <button
                                onClick={() => setShowAnalytics(false)}
                                className="text-gray-500 hover:text-gray-700 text-2xl"
                            >
                                Ã—
                            </button>
                        </div>

                        {/* ç»Ÿè®¡å¡ç‰‡ */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-2xl font-bold">{productivityMetrics.totalCompletedTasks || 0}</div>
                                        <div className="text-blue-100">å®Œæˆä»»åŠ¡</div>
                                    </div>
                                    <div className="text-3xl opacity-80">âœ…</div>
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-2xl font-bold">{productivityMetrics.totalPomodoros || 0}</div>
                                        <div className="text-green-100">æ€»ç•ªèŒ„æ•°</div>
                                    </div>
                                    <div className="text-3xl opacity-80">ğŸ…</div>
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-2xl font-bold">{Math.round(productivityMetrics.averageAccuracy || 0)}%</div>
                                        <div className="text-purple-100">æ—¶é—´é¢„ä¼°å‡†ç¡®ç‡</div>
                                    </div>
                                    <div className="text-3xl opacity-80">ğŸ¯</div>
                                </div>
                            </div>
                        </div>

                        {/* æœ€è¿‘å®Œæˆçš„ä»»åŠ¡ */}
                        <div className="mb-8">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ æœ€è¿‘å®Œæˆ</h3>
                            <div className="space-y-3">
                                {completionHistory.slice(0, 5).map((completion, index) => (
                                    <div key={index} className="p-3 bg-gray-50 rounded-lg">
                                        <div className="flex justify-between items-center">
                                            <div className="font-medium text-gray-800">{completion.taskText}</div>
                                            <div className="text-sm text-gray-600">
                                                {new Date(completion.completedAt).toLocaleDateString('zh-CN')}
                                            </div>
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            ç”¨æ—¶: {completion.actualPomodoros} ğŸ… |
                                            é¢„ä¼°: {completion.estimatedPomodoros} ğŸ… |
                                            åˆ†ç±»: {completion.category}
                                        </div>
                                    </div>
                                ))}
                                {completionHistory.length === 0 && (
                                    <div className="text-center text-gray-500 py-8">
                                        <div className="text-4xl mb-4">ğŸ“Š</div>
                                        <p>è¿˜æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡æ•°æ®</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* åˆ†ç±»ç»Ÿè®¡ */}
                        {Object.keys(productivityMetrics.categoryStats || {}).length > 0 && (
                            <div className="mb-8">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ ä»»åŠ¡åˆ†ç±»ç»Ÿè®¡</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {Object.entries(productivityMetrics.categoryStats || {}).map(([category, count]) => (
                                        <div key={category} className="p-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg">
                                            <div className="text-center">
                                                <div className="text-2xl font-bold text-gray-800">{count}</div>
                                                <div className="text-sm text-gray-600 capitalize">{category}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* å¯¼å‡ºæŒ‰é’® */}
                        <div className="flex justify-center space-x-4">
                            <button
                                onClick={exportData}
                                className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                            >
                                ğŸ“ å¯¼å‡ºæ•°æ®
                            </button>
                            <label className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors cursor-pointer">
                                ğŸ“¥ å¯¼å…¥æ•°æ®
                                <input
                                    type="file"
                                    accept=".json"
                                    onChange={importData}
                                    className="hidden"
                                />
                            </label>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <NotificationPanel />
                    
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full slide-up">
                        {/* æ ‡é¢˜å’Œæ§åˆ¶æŒ‰é’® */}
                        <div className="text-center mb-8">
                            <div className="flex justify-between items-center mb-2">
                                <div className="flex space-x-1">
                                    <button
                                        onClick={() => setShowAIChat(true)}
                                        className="p-2 text-purple-600 hover:text-purple-800 hover:bg-purple-100 rounded-full transition-colors"
                                        title="AIåŠ©æ‰‹"
                                    >
                                        ğŸ¤–
                                    </button>
                                    <button
                                        onClick={() => setShowTimeBlocks(true)}
                                        className="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-full transition-colors"
                                        title="æ—¶é—´è§„åˆ’"
                                    >
                                        â°
                                    </button>
                                </div>
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                                    ğŸ… AIç•ªèŒ„æ—¶é’Ÿ
                                </h1>
                                <div className="flex space-x-1">
                                    <button
                                        onClick={() => setShowTaskManager(true)}
                                        className="p-2 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 rounded-full transition-colors"
                                        title="ä»»åŠ¡ç®¡ç†"
                                    >
                                        ğŸ“‹
                                    </button>
                                    <button
                                        onClick={() => setShowAnalytics(true)}
                                        className="p-2 text-green-600 hover:text-green-800 hover:bg-green-100 rounded-full transition-colors"
                                        title="æ•°æ®åˆ†æ"
                                    >
                                        ğŸ“Š
                                    </button>
                                </div>
                            </div>
                            <p className="text-gray-600">AIé©±åŠ¨çš„æ™ºèƒ½ä¸“æ³¨å·¥ä½œæ³•</p>
                        </div>

                        {/* å½“å‰ä»»åŠ¡æ˜¾ç¤º */}
                        {currentTask && (
                            <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                                <div className="text-sm text-blue-600 mb-1 flex items-center justify-between">
                                    <span>å½“å‰ä»»åŠ¡</span>
                                    <span className={`px-2 py-1 text-xs rounded-full ${
                                        currentTask.priority === 'high' ? 'bg-red-100 text-red-700' :
                                        currentTask.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                        'bg-green-100 text-green-700'
                                    }`}>
                                        {currentTask.priority === 'high' ? 'ğŸ”´ é«˜' : 
                                         currentTask.priority === 'medium' ? 'ğŸŸ¡ ä¸­' : 
                                         'ğŸŸ¢ ä½'}
                                    </span>
                                </div>
                                <div className="font-medium text-blue-800">{currentTask.text}</div>
                                <div className="text-sm text-blue-600 mt-1 flex items-center justify-between">
                                    <span>è¿›åº¦: {currentTask.completedPomodoros} / {currentTask.estimatedPomodoros} ğŸ…</span>
                                    {currentTask.aiGenerated && (
                                        <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                                            ğŸ¤– AIæ¨è
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* AIå»ºè®®å¿«é€Ÿæ˜¾ç¤º */}
                        {aiSuggestions.length > 0 && (
                            <div className="mb-6 p-3 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl border border-purple-200">
                                <div className="text-sm font-medium text-purple-800 mb-1 flex items-center justify-between">
                                    <span>âœ¨ AIå»ºè®®</span>
                                    <span className="text-xs">{aiSuggestions.length} é¡¹</span>
                                </div>
                                <div className="text-sm text-purple-700">
                                    {aiSuggestions[0].message}
                                </div>
                                <button
                                    onClick={() => setShowTaskManager(true)}
                                    className="text-xs text-purple-600 hover:text-purple-800 mt-1"
                                >
                                    æŸ¥çœ‹å…¨éƒ¨å»ºè®® â†’
                                </button>
                            </div>
                        )}

                        {/* ä¼šè¯ç±»å‹é€‰æ‹© */}
                        <div className="flex justify-center mb-6">
                            <div className="bg-gray-100 rounded-full p-1 flex">
                                {Object.keys(sessionTimes).map((type) => (
                                    <button
                                        key={type}
                                        onClick={() => changeSessionType(type)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                            sessionType === type
                                                ? `bg-gradient-to-r ${sessionColors[type]} text-white shadow-lg transform scale-105`
                                                : 'text-gray-600 hover:text-gray-800 hover:bg-gray-200'
                                        }`}
                                    >
                                        {sessionNames[type]}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* åœ†å½¢è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º */}
                        <div className="relative flex items-center justify-center mb-8">
                            <div className="relative w-64 h-64">
                                <div className="absolute inset-0 rounded-full bg-gray-200"></div>
                                
                                <div 
                                    className={`absolute inset-0 rounded-full bg-gradient-to-r ${sessionColors[sessionType]}`}
                                    style={{
                                        background: `conic-gradient(from 0deg, transparent ${360 - (getProgress() * 3.6)}deg, currentColor ${360 - (getProgress() * 3.6)}deg)`
                                    }}
                                ></div>
                                
                                <div className="absolute inset-4 bg-white rounded-full flex items-center justify-center shadow-inner">
                                    <div className="text-center">
                                        <div className="text-4xl font-bold text-gray-800 mb-2">
                                            {formatTime(timeLeft)}
                                        </div>
                                        <div className="text-lg font-medium text-gray-600">
                                            {sessionNames[sessionType]}
                                        </div>
                                    </div>
                                </div>

                                {isActive && (
                                    <div className={`absolute inset-0 rounded-full bg-gradient-to-r ${sessionColors[sessionType]} opacity-20 pulse-ring`}></div>
                                )}
                            </div>
                        </div>

                        {/* æ§åˆ¶æŒ‰é’® */}
                        <div className="flex justify-center space-x-4 mb-6">
                            <button
                                onClick={toggleTimer}
                                className={`px-8 py-3 rounded-full font-semibold text-white shadow-lg transform transition-all hover:scale-105 active:scale-95 ${
                                    isActive 
                                        ? 'bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700'
                                        : `bg-gradient-to-r ${sessionColors[sessionType]} hover:shadow-xl`
                                }`}
                            >
                                {isActive ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ å¼€å§‹'}
                            </button>
                            
                            <button
                                onClick={resetTimer}
                                className="px-6 py-3 rounded-full font-semibold text-gray-600 bg-gray-200 hover:bg-gray-300 shadow-lg transform transition-all hover:scale-105 active:scale-95"
                            >
                                ğŸ”„ é‡ç½®
                            </button>
                        </div>

                        {/* ç»Ÿè®¡ä¿¡æ¯ */}
                        <div className="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-4 mb-4">
                            <div className="flex justify-between items-center">
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-800">{sessionCount}</div>
                                    <div className="text-sm text-gray-600">å®Œæˆè½®æ¬¡</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-800">{totalSessions}</div>
                                    <div className="text-sm text-gray-600">æ€»ç•ªèŒ„æ•°</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-800">{Math.floor(sessionCount / 4)}</div>
                                    <div className="text-sm text-gray-600">é•¿ä¼‘æ¯</div>
                                </div>
                            </div>
                        </div>

                        {/* åŠŸèƒ½å¿«æ·æŒ‰é’® */}
                        <div className="grid grid-cols-2 gap-3 mb-4">
                            <button
                                onClick={analyzeTasksWithAI}
                                disabled={isAIProcessing}
                                className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors disabled:opacity-50 text-sm"
                            >
                                {isAIProcessing ? 'ğŸ¤” åˆ†æä¸­...' : 'ğŸ”„ AIä¼˜åŒ–'}
                            </button>
                            <button
                                onClick={shareSession}
                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                            >
                                ğŸ¤ åˆ†äº«ä¼šè¯
                            </button>
                        </div>

                        {/* åº•éƒ¨çŠ¶æ€æŒ‡ç¤º */}
                        <div className="text-center text-sm text-gray-500">
                            <div className="flex items-center justify-center space-x-4">
                                <div className="flex items-center space-x-1">
                                    <span>ğŸ¤–</span>
                                    <div className={`w-2 h-2 rounded-full ${aiService.isOnline ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                    <span>AI {aiService.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span>
                                </div>
                                <div className="flex items-center space-x-1">
                                    <span>ğŸ’¾</span>
                                    <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <span>è‡ªåŠ¨ä¿å­˜</span>
                                </div>
                                {collaborationEnabled && (
                                    <div className="flex items-center space-x-1">
                                        <span>ğŸ¤</span>
                                        <div className="w-2 h-2 rounded-full bg-green-500 collaboration-indicator"></div>
                                        <span>åä½œä¸­</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* å¼¹çª—ç»„ä»¶ */}
                    {showAIChat && <AIChat />}
                    {showTimeBlocks && <TimeBlocksView />}
                    {showTaskManager && <TaskManager />}
                    {showAnalytics && <Analytics />}
                </div>
            );
        };

        ReactDOM.render(<ComprehensiveAIPomodoro />, document.getElementById('root'));
    </script>
</body>
</html>